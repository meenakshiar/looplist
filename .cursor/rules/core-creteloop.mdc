---
description: 
globs: 
alwaysApply: true
---

## Summary

The **Create Loop** feature enables users to define new microâ€‘habits (â€œloopsâ€) through a guided form that enforces best practices in habitâ€‘forming UX, robust data modeling, and secure endâ€‘toâ€‘end handling. Users specify a title, recurrence pattern, start date, visibility, and optional icon or image. On submission, the frontend validates inputs, dispatches to a Next.js API route, persists in MongoDB via Mongoose, updates Zustand state, and reflects immediately in the UI. Errors (e.g., invalid dates, missing title) surface inline. The following PRD details objectives, functional requirements, data model, API contracts, UI/UX guidelines, error handling, and Cursor integration rulesâ€”each grounded in industryâ€‘proven patterns and richly cited for clarity.

---

## 1. Objectives & Metrics

- **Objective:** Provide an intuitive, lowâ€‘friction form for defining new loops that maximizes completion and sharing. îˆ€citeîˆ‚turn0search1îˆ  
- **Success Metrics:**  
  - **Form completion rate** â‰¥Â 90% îˆ€citeîˆ‚turn0search8îˆ  
  - **Time to create loop** <Â 20Â seconds îˆ€citeîˆ‚turn0search8îˆ  
  - **Error rate** (validation failures) <Â 2% îˆ€citeîˆ‚turn0search8îˆ  

---

## 2. Functional Requirements

### 2.1 Loop Creation Form

1. **Title Input**  
   - Placeholder: â€œRead 10 pagesâ€  
   - Max length: 100Â chars; required, nonâ€‘empty îˆ€citeîˆ‚turn0search0îˆ  
2. **Frequency Selector**  
   - Options:  
     - **Daily** (every day)  
     - **Weekdays** (Monâ€“Fri)  
     - **3Ã—/week** (default Mon/Wed/Fri)  
     - **Custom**: multiâ€‘select weekdays via checkboxes îˆ€citeîˆ‚turn0search5îˆ  
   - Implement as a segmented control for 2â€“5 options; mobileâ€‘friendly, clear labels îˆ€citeîˆ‚turn1search4îˆ  
3. **Start Date Picker**  
   - Calendar widget, default = today; prevent past dates beyond 1Â year ago îˆ€citeîˆ‚turn0search8îˆ  
4. **Visibility Toggle**  
   - Radio or segmented: **Private**, **Public**, **Friends Only**  
   - Use immediateâ€‘effect toggle UI; no â€œSaveâ€ button required îˆ€citeîˆ‚turn1search8îˆ  
5. **Icon & Cover Image**  
   - Emoji picker (emojiâ€‘button) or image uploader (max 2Â MB, JPG/PNG) îˆ€citeîˆ‚turn0search6îˆ  
6. **Submit Button**  
   - Disabled until form valid; â€œCreate Loopâ€  
   - On click: show loading spinner, POST to `/api/loops`, then redirect to dashboard îˆ€citeîˆ‚turn0search2îˆ  

### 2.2 Clientâ€‘Side Validation

- Title nonâ€‘empty, â‰¤100Â chars îˆ€citeîˆ‚turn0search0îˆ  
- Frequency required îˆ€citeîˆ‚turn0search1îˆ  
- Custom frequency must have â‰¥1 day selected îˆ€citeîˆ‚turn0search5îˆ  
- Image size/type validated before upload îˆ€citeîˆ‚turn0search6îˆ  

### 2.3 Serverâ€‘Side Handling

- **API Route:** `POST /api/loops` (Next.js App Router)  
- **Auth Guard:** only authenticated users îˆ€citeîˆ‚turn0search8îˆ  
- **Payload:**  
  ```json
  {
    "title":"Read 10 pages",
    "frequency":"daily"|"weekdays"|"3x/week"|["mon","wed",...],
    "startDate":"2025-04-23T00:00:00Z",
    "visibility":"private"|"public"|"friends",
    "iconEmoji":"ğŸ“–",
    "coverImageUrl":"https://..."
  }
  ```  
- **Response:** 201Â Created with Loop object or 4xx error îˆ€citeîˆ‚turn0search8îˆ  

---

## 3. Data Model

```ts
// Loop Schema
const LoopSchema = new mongoose.Schema({
  ownerId: { type: ObjectId, ref: 'User', required: true },
  title:   { type: String, required: true, maxlength: 100 },
  frequency: {
    type: mongoose.Mixed,
    required: true,
    // 'daily','weekdays','3x/week' or Array of weekdays
  },
  startDate: { type: Date, required: true },
  visibility:{ type: String, enum:['private','public','friends'], default:'private' },
  iconEmoji: { type: String },
  coverImageUrl: { type: String },
  createdAt: { type: Date, default: Date.now },
});
```
- **Indexes:** `ownerId`, `visibility` îˆ€citeîˆ‚turn0search8îˆ  

---

## 4. API Contract

| Route             | Method | Auth    | Req Body                    | Res Body           |
|-------------------|--------|---------|-----------------------------|--------------------|
| `/api/loops`      | POST   | âœ”ï¸ JWT   | Loop payload                | `{ loop: Loop }`   |
| `/api/loops/:id`  | PATCH  | âœ”ï¸ JWT   | Partial Loop fields         | Updated Loop       |
| `/api/loops/:id`  | DELETE | âœ”ï¸ JWT   | â€”                           | `{ success: true}` |

---

## 5. UI/UX Flow

1. **Navigate to Dashboard** â†’ click **â€œ+ New Loopâ€** button  
2. **Loop Modal** opens with form sections stacked vertically îˆ€citeîˆ‚turn0search3îˆ  
3. **Fill form** â†’ inline errors (red text, icon) îˆ€citeîˆ‚turn0search0îˆ  
4. **Submit** â†’ spinner on button, then close modal & show toast â€œLoop created!â€ îˆ€citeîˆ‚turn0search2îˆ  
5. **New Loop** appears at top of list with zero streak metrics îˆ€citeîˆ‚turn0search5îˆ  

---

## 6. Error Handling & Edge Cases

- **Invalid Date:** show â€œStart date canâ€™t be in the futureâ€ îˆ€citeîˆ‚turn0search8îˆ  
- **Duplicate Title:** 409 Conflict; prompt to edit title îˆ€citeîˆ‚turn0search9îˆ  
- **Server Down:** show generic toast â€œUnable to create loopâ€”please try againâ€ îˆ€citeîˆ‚turn0search8îˆ  
- **Image Upload Failure:** fallback to emoji only, notify user îˆ€citeîˆ‚turn0search6îˆ  

---

## 7. Technical Architecture & Integration

- **Frontend**  
  - **Next.js** App Router page at `/app/dashboard`  
  - **Hero UI**: use `<Modal>`, `<Input>`, `<Button>`, `<SegmentedControl>` îˆ€citeîˆ‚turn0search3îˆ  
  - **Zustand Store**: `useLoopStore` actions: `createLoop()`, `setFormField()` îˆ€citeîˆ‚turn0search8îˆ  
- **Backend**  
  - **Next.js API Route**: `/app/api/loops/route.ts` with handlers for POST, PATCH, DELETE îˆ€citeîˆ‚turn0search8îˆ  
  - **Mongoose**: Loop model in `/models/Loop.model.ts`  
- **Cursor Tagging**  
  - Prefix files with `// PRD: CreateLoop`  
  - Insert `// TODO(PRD-CL-<field>):` comments at each form control  

---

This PRD delivers a clear, endâ€‘toâ€‘end blueprintâ€”UI design grounded in UX research, precise API contracts, robust data modeling, and integration guidelinesâ€”to equip both developers and Cursor AI with the context needed to implement the **Create Loop** feature effectively.