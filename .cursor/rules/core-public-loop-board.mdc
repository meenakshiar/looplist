---
description: 
globs: 
alwaysApply: true
---
## Summary

The **Public Loop Boards** feature provides a dynamic, infiniteâ€‘scroll feed of userâ€‘shared habit loops, enabling exploration, social reactions (â€œCheerâ€), and cloning. It leverages best practices in social feed designâ€”optimizing performance with lazy loading and â€œLoad Moreâ€ fallbacks îˆ€citeîˆ‚turn0search4îˆâ€”and ensures accessibility through ARIA roles and keyboard support îˆ€citeîˆ‚turn0search6îˆ. Backend endpoints support efficient pagination with cursorâ€‘based queries, while frontâ€‘end components in Next.js and HeroÂ UI implement cardâ€‘based layouts, reaction buttons, and clone actions. This PRD details objectives, metrics, functional and nonâ€‘functional requirements, data models, API contracts, UI/UX flows, error handling, technical integration, and Cursor tagging rules.

---

## 1. Objectives & Success Metrics

- **Objective:** Foster community engagement by surfacing public habit loops in an intuitive, performant feed, driving â€œCheerâ€ reactions and loop cloning.  
- **Metrics:**  
  - **Feed Engagement Rate:** â‰¥Â 60% of users perform at least one action (reaction or clone) per session îˆ€citeîˆ‚turn0search0îˆ.  
  - **Time to First Action:** <Â 15Â seconds after feed load îˆ€citeîˆ‚turn0search2îˆ.  
  - **Infinite Scroll Performance:** 90thâ€‘percentile frame rendering <Â 16Â ms on midâ€‘range devices îˆ€citeîˆ‚turn0search1îˆ.  
  - **Accessibility Compliance:** WCAGÂ 2.1Â AA for role="feed" and keyboard navigation îˆ€citeîˆ‚turn0search6îˆ.  

---

## 2. Functional Requirements

### 2.1 Feed Listing & Navigation

- **Infinite Scroll with Loadâ€‘More Fallback:** Automatically load next batch when near viewport bottom; include a â€œLoad Moreâ€ button as per best practices îˆ€citeîˆ‚turn0search4îˆ.  
- **Cursorâ€‘Based Pagination:** Backend returns `nextCursor` to fetch subsequent pages, avoiding offset pitfalls îˆ€citeîˆ‚turn0search4îˆ.  
- **Card Layout:** Display each public loop as a card showing title, current streak, owner handle, and cover/icon îˆ€citeîˆ‚turn1search8îˆ.  
- **Filters & Sorting:** Sidebar or topbar filtersâ€”Frequency, Streak Length, Newest, Most Cheeredâ€”using faceted patterns îˆ€citeîˆ‚turn1search2îˆ.  

### 2.2 Social Reactions (â€œCheerâ€)

- **Emoji Reactions:** Predefined set + custom picker; increment reactor count on click îˆ€citeîˆ‚turn0search7îˆ.  
- **Optimistic UI Update:** Reflect reaction instantly; reconcile with server response îˆ€citeîˆ‚turn0search2îˆ.  
- **Reaction Summary:** Show top three emojis with counts, link to reactors list îˆ€citeîˆ‚turn1search9îˆ.  

### 2.3 Loop Cloning

- **Clone Action:** Clicking â€œCloneâ€ deepâ€‘copies loop settings (frequency, start date resets to today, visibility default private) into userâ€™s loops îˆ€citeîˆ‚turn1search3îˆ.  
- **Feedback Flow:** Show confirmation modal with â€œView My Loopsâ€ or â€œContinue Browsingâ€ options îˆ€citeîˆ‚turn0search2îˆ.  

---

## 3. Data Models

```ts
// PublicLoop View Model
interface PublicLoop {
  loopId:      ObjectId;
  ownerId:     ObjectId;
  ownerName:   string;
  title:       string;
  frequency:   string | string[];
  currentStreak:number;
  longestStreak:number;
  coverImage?: string;
  iconEmoji?:  string;
  cheeredCount:number;
  clonedCount: number;
  createdAt:   Date;
}

// Reaction Schema (existing)
interface Reaction {
  loopId: ObjectId;
  userId: ObjectId;
  emoji:  string;
  createdAt: Date;
}

// Clone Log
interface Clone {
  originalLoopId: ObjectId;
  clonedBy:       ObjectId;
  clonedAt:       Date;
}
```

---

## 4. API Contract

| Route                                 | Method | Auth  | Query/Body                                           | Response                                     |
|---------------------------------------|--------|-------|------------------------------------------------------|----------------------------------------------|
| `/api/explore`                        | GET    | âŒ     | `?cursor=â€¦&limit=â€¦&filtersâ€¦`                         | `{ loops: PublicLoop[], nextCursor: string }` |
| `/api/loops/:id/react`                | POST   | âœ”ï¸     | `{ emoji: "ğŸ‰" }`                                     | `{ reaction: Reaction }`                     |
| `/api/loops/:id/clone`                | POST   | âœ”ï¸     | â€”                                                    | `{ loop: Loop }`                             |

---

## 5. UI/UX Flow

1. **Access Explore Page:** Unauthenticated users see readâ€‘only feed; loggedâ€‘in users see action buttons îˆ€citeîˆ‚turn0search0îˆ.  
2. **Scroll to Load:** As user scrolls, feed autoâ€‘fetches next page; if performance issues, user can tap â€œLoad Moreâ€ îˆ€citeîˆ‚turn0search4îˆ.  
3. **React & Clone:** Tapping â€œCheerâ€ or â€œCloneâ€ triggers optimistic updates; modals and toasts confirm actions îˆ€citeîˆ‚turn0search7îˆ.  
4. **Filtering:** Users open filter panel, adjust facets, and feed reâ€‘requests with new query params îˆ€citeîˆ‚turn1search2îˆ.  
5. **Return to Top:** Persistent â€œBack to Topâ€ button ensures users can easily navigate feed end îˆ€citeîˆ‚turn0search4îˆ.  

---

## 6. Error Handling & Edge Cases

- **Network Failures:** Display inline error banner (â€œUnable to load more loopsâ€), allow retry îˆ€citeîˆ‚turn0search2îˆ.  
- **No More Content:** At end of feed, show â€œYouâ€™ve seen all loopsâ€ message îˆ€citeîˆ‚turn0search4îˆ.  
- **Concurrent Reactions:** Debounce rapid clicks; handle 409 Conflict by ignoring duplicates îˆ€citeîˆ‚turn0search7îˆ.  
- **Accessibility:** Ensure `role="feed"` and `aria-live` attributes for screen readers îˆ€citeîˆ‚turn0search6îˆ.  

---

## 7. Technical Architecture & Integration

- **Frontend (Next.js + HeroÂ UI + Zustand):**  
  - **Component:** `<ExploreFeed>` uses `useExploreStore` for loop pages îˆ€citeîˆ‚turn1search8îˆ.  
  - **InfiniteScroll Hook:** Custom hook wrapping IntersectionObserver for lazy load îˆ€citeîˆ‚turn0search1îˆ.  
  - **Filter Panel:** `<FilterDrawer>` with faceted UI patterns îˆ€citeîˆ‚turn1search2îˆ.  
- **Backend (Next.js API Routes + Mongoose):**  
  - **Pagination:** Query with `createdAt` or `_id` cursor; index on `visibility` and `createdAt` îˆ€citeîˆ‚turn0search4îˆ.  
  - **Reaction & Clone Handlers:** Idempotent operations in `/app/api/loops/[id]/react` and `/clone` routes îˆ€citeîˆ‚turn1search3îˆ.  

---

## 8. Cursor Integration Rules

- **File Prefixes:** Begin new components/API files with `// PRD: PublicLoopBoard` for context linking.  
- **TODO Tags:** Use `// TODO(PRD-PLB-<ID>):` at feed logic, filter implementation, and UX edge cases.  
- **Schema Comments:** JSDoc on view models explaining each fieldâ€™s purpose.  
- **Folder README:** Add `/components/ExploreFeed/README.md` summarizing component roles for Cursor.  

---

This PRD ensures seamless endâ€‘toâ€‘end implementation of **Public Loop Boards**, guiding both developers and AI assistants like Cursor with precise requirements, bestâ€‘practice citations, and integration conventions.