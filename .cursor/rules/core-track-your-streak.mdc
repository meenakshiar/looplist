---
description: 
globs: 
alwaysApply: true
---
## Summary

Effective habitâ€‘tracking interfaces employ a oneâ€‘tap daily checkâ€‘in combined with immediate visual feedback to sustain user motivation and reduce friction îˆ€citeîˆ‚turn0search1îˆ. Under the hood, streak counts are calculated by iterating through historical checkâ€‘in records and resetting upon a missed day, ensuring accurate â€œcurrentâ€ and â€œlongestâ€ streak metrics îˆ€citeîˆ‚turn0search8îˆ. A rich statistics panelâ€”displaying current streak, longest streak, completion rate, and a GitHubâ€‘style heatmap calendarâ€”reinforces user accountability and progress visibility îˆ€citeîˆ‚turn1search4îˆ.

---

## 1. Objectives & Metrics

- **Objective:** Enable users to effortlessly mark daily habit completions and visualize streak progress in real time îˆ€citeîˆ‚turn0search5îˆ.  
- **Success Metrics:**  
  - **Daily Checkâ€‘in Rate:** â‰¥Â 85% of active loops receive a checkâ€‘in each expected day îˆ€citeîˆ‚turn0search5îˆ.  
  - **Feature Engagement:** â‰¥Â 70% of users view their statistics panel at least once per week îˆ€citeîˆ‚turn0search5îˆ.  
  - **Streak Accuracy:** 100% correctness in current/longest streak calculations over a 30â€‘day rolling window îˆ€citeîˆ‚turn0search8îˆ.

---

## 2. Functional Requirements

### 2.1 Daily Checkâ€‘In Interaction

- **UI Control:** A prominent â€œDoneâ€ button on each loop card or detail view that requires a single tap/click îˆ€citeîˆ‚turn0search1îˆ.  
- **Timing Window:** Userâ€™s local midnight to midnight window; system automatically rolls over at 00:00 local time îˆ€citeîˆ‚turn0search1îˆ.  
- **Optimistic Update:** Immediately update UI state to â€œdoneâ€ upon tap, then persist in the background for snappy feedback îˆ€citeîˆ‚turn0search1îˆ.  

### 2.2 Loop State Indicators

- **ğŸŸ© Active:** Indicates the streak is ongoing with no missed days îˆ€citeîˆ‚turn0search4îˆ.  
- **ğŸŸ¥ Broken:** Marks the loop as broken when the user misses a scheduled checkâ€‘in; resets current streak to zero îˆ€citeîˆ‚turn0search8îˆ.  
- **âœ… Completed:** For loops with defined end dates or target counts, marks final completion (optional feature extension) îˆ€citeîˆ‚turn0search7îˆ.  

### 2.3 Statistics Panel

- **Current Streak:** Consecutive days with successful checkâ€‘ins îˆ€citeîˆ‚turn0search8îˆ.  
- **Longest Streak:** Maximum historical run of consecutive checkâ€‘ins îˆ€citeîˆ‚turn0search8îˆ.  
- **Completion Rate:** Ratio of total completed days to expected occurrences (expressed as a percentage) îˆ€citeîˆ‚turn0search7îˆ.  
- **Trend Insights:** Optional sparkline or miniâ€‘chart showing checkâ€‘in frequency over past 30 days îˆ€citeîˆ‚turn0search1îˆ.  

### 2.4 Heatmap Calendar

- **Inspiration:** GitHubâ€‘style yearâ€‘long grid where each cellâ€™s color intensity reflects checkâ€‘in frequency îˆ€citeîˆ‚turn1search4îˆ.  
- **Library Options:**  
  - **Calâ€‘Heatmap:** Vanilla JS, highly configurable for domain/subdomain mapping îˆ€citeîˆ‚turn1search1îˆ.  
  - **reactâ€‘heatâ€‘map (uiwjs):** Lightweight React component built on SVG, ideal for Next.js îˆ€citeîˆ‚turn1search6îˆ.  
- **Interactivity:** Hover/click on cells to reveal date and status details; color scale from empty (no checkâ€‘ins) to dark (high consistency) îˆ€citeîˆ‚turn1search4îˆ.  

---

## 3. Data Model

```ts
// CheckIn Schema
const CheckInSchema = new mongoose.Schema({
  loopId:    { type: ObjectId, ref: 'Loop', required: true },  // Link to parent loop
  date:      { type: Date, required: true, index: true },      // Midnight UTC of checkâ€‘in
  status:    { type: String, enum: ['done','missed'], required: true },
  createdAt: { type: Date, default: Date.now },
});
```

> **Calculation Logic:** Backend workflows should scan `CheckIn` records in date order, incrementing a counter for each â€œdoneâ€ and resetting on â€œmissedâ€ to derive current and longest streaks îˆ€citeîˆ‚turn0search8îˆ.

---

## 4. API Contract

| Route                                 | Method | Auth  | Request Body                             | Response                      |
|---------------------------------------|--------|-------|------------------------------------------|-------------------------------|
| `/api/loops/:id/checkin`              | POST   | âœ”ï¸ JWT | `{ date: "2025-04-23T00:00:00Z" }`       | `{ checkIn: CheckIn }`        |
| `/api/loops/:id/stats`                | GET    | âœ”ï¸ JWT | â€”                                        | `{ currentStreak, longestStreak, completionRate }` |
| `/api/loops/:id/checkin/:date`        | DELETE | âœ”ï¸ JWT | â€”                                        | `{ success: true }`           |

> **Idempotency:** POST `/checkin` must be idempotent per date to prevent duplicate records îˆ€citeîˆ‚turn0search8îˆ.

---

## 5. UI/UX Flow

1. **Dashboard View:** Each loop card shows a â€œDoneâ€ button and colored status square îˆ€citeîˆ‚turn0search1îˆ.  
2. **Checkâ€‘In:** User taps â€œDoneâ€ â†’ card icon turns ğŸŸ© â†’ underlying POST request sent îˆ€citeîˆ‚turn0search1îˆ.  
3. **Stats Panel:** On click or at page load, fetch `/stats` â†’ render current/longest streak and rate îˆ€citeîˆ‚turn0search7îˆ.  
4. **Heatmap:** Toggle â€œView Heatmapâ€ in stats panel â†’ render calendar component with interactive dates îˆ€citeîˆ‚turn1search6îˆ.

---

## 6. Error Handling & Edge Cases

- **Network Failures:** Revert optimistic UI on failure; show toast â€œCheckâ€‘in failed, try againâ€ îˆ€citeîˆ‚turn0search1îˆ.  
- **Duplicate Checkâ€‘In Attempt:** Return 409 Conflict; silently ignore with no UI change îˆ€citeîˆ‚turn0search8îˆ.  
- **Missed Day Transition:** At local midnight, autoâ€‘mark missed for loops not checked in, triggering Broken state îˆ€citeîˆ‚turn0search8îˆ.  
- **Timezone Shifts:** Normalize dates to UTC midnight but calculate streak windows in userâ€™s timezone to avoid offâ€‘byâ€‘one errors îˆ€citeîˆ‚turn0search1îˆ.

---

## 7. Technical Architecture & Integration

- **Frontend (Next.js + Hero UI + Zustand):**  
  - **State Store:** `useCheckInStore` with actions `submitCheckIn()`, `fetchStats()` îˆ€citeîˆ‚turn0search5îˆ.  
  - **Components:** `<LoopCard>` for checkâ€‘in button, `<StatsPanel>`, `<HeatmapCalendar>` using `reactâ€‘heatâ€‘map` îˆ€citeîˆ‚turn1search6îˆ.  
- **Backend (Next.js API Routes + Mongoose):**  
  - **Routes:** Implement under `/app/api/loops/[id]/checkin/route.ts` and `/stats/route.ts` îˆ€citeîˆ‚turn0search8îˆ.  
  - **Models:** `CheckIn` and existing `Loop` schemas in `/models` îˆ€citeîˆ‚turn0search8îˆ.  
- **Deployment:** Ensure MongoDB indices on `(loopId, date)` for performant lookups îˆ€citeîˆ‚turn0search8îˆ.

---

## 8. Cursor Integration Rules

- **File Headers:** Prefix new files with `// PRD: TrackStreaks` to link code to this specification.  
- **TODO Tags:** Introduce `// TODO(PRD-TS-<ID>):` comments at checkâ€‘in logic, stats fetch, and calendar rendering points.  
- **Schema Documentation:** JSDoc comments on `CheckInSchema` fields explaining usage and TTL behavior.  
- **Folder Readmes:** Add a `README.md` in `/components/TrackStreaks` summarizing component roles for Cursor context.

---

This document provides a complete endâ€‘toâ€‘end blueprint for implementing the **Track Your Streaks** featureâ€”ensuring clarity for both human engineers and AIâ€‘driven tools like Cursor.